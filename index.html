<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Equipo IA: Misi√≥n Rescate</title>

<!--
==============================================================
EQUIPO IA: MISI√ìN RESCATE ‚Äî SPA en un solo archivo
Autor: ChatGPT (para @cris, Gnius Club)
Requisitos cubiertos:
- HTML √∫nico con CSS y JS embebidos (sin dependencias externas)
- Pantallas: Base de Mando (briefing), Juego (vista lateral), Final
- Personajes: Comandante (humano) y robot Bolt
- Obst√°culos secuenciales + mec√°nica de arrastrar/soltar (con soporte t√°ctil)
- Men√∫ de comandos con iconos grandes y alto contraste
- Progreso de misi√≥n, feedback visual/sonoro y narrado (SpeechSynthesis)
- Accesible, responsive (desktop/m√≥vil), c√≥digo comentado y organizado
- Rejugabilidad b√°sica: medallas por eficiencia, pistas, ‚Äúmejoras‚Äù cosm√©ticas para Bolt
==============================================================
-->

<style>
  :root{
    --bg:#0b1020;
    --panel:#0f1730;
    --accent:#00e0ff;
    --accent-2:#19ff84;
    --warning:#ff385c;
    --ok:#21e37c;
    --text:#f5fbff;
    --muted:#b6c7d9;
    --shadow:0 10px 24px rgba(0,0,0,.35);
    --card: #111a36;
    --gold: #ffd54a;
    --silver:#cfd8dc;
    --bronze:#d79a6a;
  }

  /* Reset b√°sico */
  * { box-sizing: border-box; }
  html, body { height: 100%; }
  body{
    margin:0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji","Segoe UI Emoji";
    color:var(--text);
    background: radial-gradient(1200px 600px at 70% -10%, #15224c 0%, var(--bg) 60%);
    overflow-x:hidden;
  }

  /* Layout principal */
  .container{
    max-width:1100px;
    margin:0 auto;
    padding: clamp(12px, 2vw, 24px);
  }

  .card{
    background:linear-gradient(180deg, #0c1534 0%, var(--card) 100%);
    border:1px solid #1b2b6b;
    border-radius:18px;
    box-shadow: var(--shadow);
    padding: clamp(14px, 2vw, 24px);
  }

  h1,h2,h3{
    margin:8px 0 12px;
    letter-spacing:.3px;
  }

  .title{
    font-size: clamp(22px, 4vw, 36px);
    line-height:1.1;
    display:flex; align-items:center; gap:10px;
  }
  .subtitle{ color:var(--muted); margin-top:-4px; font-size:clamp(14px,2.2vw,16px); }

  /* Barra superior */
  .topbar{
    display:flex; align-items:center; justify-content:space-between;
    gap:10px; margin-bottom:12px;
  }
  .badge{
    background:linear-gradient(90deg, #072343, #053457);
    border:1px solid #0e4d7e;
    color:#baf1ff;
    padding:6px 10px; border-radius:999px;
    font-size:12px; letter-spacing:.5px;
  }

  /* Controles globales */
  .toggles{
    display:flex; flex-wrap:wrap; gap:8px;
  }
  .toggle{
    background:#0a1534; border:1px solid #21346b; color:#d6e7ff;
    padding:8px 10px; border-radius:10px; cursor:pointer;
    font-size:14px;
  }
  .toggle[aria-pressed="true"]{ outline:2px solid var(--accent); }

  /* Pantallas/escenas */
  .scene{ display:none; }
  .scene.active{ display:block; }

  /* ====== SCENE: BRIEFING ====== */
  .briefing-grid{
    display:grid; gap:16px;
    grid-template-columns: 1.2fr .8fr;
  }
  @media (max-width:900px){
    .briefing-grid{ grid-template-columns: 1fr; }
  }

  .ops-chief{
    display:flex; gap:14px; align-items:center;
    background:linear-gradient(180deg,#10255a,#0c1e45);
    border:1px solid #294aa1; border-radius:16px; padding:12px;
  }
  .ops-avatar{
    width:64px; height:64px; border-radius:14px; background:#1a2d6b;
    display:grid; place-items:center; font-size:34px;
    border:2px solid #2e58c6;
  }
  .ops-speech{
    font-size:15px; color:#dbe9ff;
  }
  .ability-list{
    display:grid; gap:10px;
  }
  .chip{
    display:inline-flex; align-items:center; gap:8px;
    border:1px dashed #2a4bb2; color:#cfe7ff; padding:8px 10px; border-radius:12px;
    background:#0c1840;
  }
  .cta{
    display:inline-block; margin-top:8px;
    background: linear-gradient(90deg, #00e0ff, #00ffa8);
    color:#001b2b; font-weight:700; border:none; border-radius:12px;
    padding:12px 16px; cursor:pointer; font-size:16px;
    box-shadow:0 8px 20px rgba(0, 255, 191, .2);
  }

  /* ====== SCENE: GAME ====== */

  /* HUD superior */
  .hud{
    display:flex; align-items:center; gap:12px; flex-wrap:wrap;
    margin-bottom:12px;
  }
  .robot-pill{
    display:flex; align-items:center; gap:10px; padding:8px 12px;
    border-radius:999px; border:1px solid #3554c7; background:#0b1a44;
  }
  .robot-emoji{
    width:32px; height:32px; border-radius:8px; display:grid; place-items:center;
    font-size:20px; background:#152a6a; border:2px solid #4c7dff;
  }
  .progress{
    flex:1; height:14px; background:#0a1333; border:1px solid #1e3681; border-radius:999px; overflow:hidden;
  }
  .progress > span{
    display:block; height:100%; width:0%;
    background: linear-gradient(90deg, #00ffa8, #00e0ff);
    transition: width .35s ease;
  }
  .hint{
    font-size:13px; color:#c4e7ff; background:#0b1c49; border:1px solid #294aa1; padding:6px 8px; border-radius:10px;
  }

  /* Zona de juego lateral */
  .playfield{
    position:relative; border:1px solid #24418f; border-radius:18px;
    background:
      linear-gradient(0deg, rgba(12,26,64,.8), rgba(12,26,64,.8)),
      url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="280" height="200"><g fill="none" stroke="%231a2f6f" stroke-width="1"><path d="M0 50h280M0 100h280M0 150h280"/><path d="M70 0v200M140 0v200M210 0v200"/></g></svg>');
    background-size: cover;
    min-height: 320px;
    padding:16px;
    display:grid;
    grid-template-columns: repeat(4, 1fr);
    gap:10px;
  }

  .obstacle, .ally{
    border:1px solid #3154c9; background:#0a1a44; border-radius:14px; padding:10px;
    min-height:110px; position:relative;
    outline-offset:3px;
  }
  .obstacle h4, .ally h4{ margin:0 0 6px; font-size:14px; color:#a8c9ff; }
  .obstacle .body, .ally .body{
    font-size:32px; line-height:1; display:flex; align-items:center; justify-content:center;
    height:70px;
  }
  .droppable{
    outline:2px dashed #4da7ff;
  }
  .ok{ box-shadow:0 0 0 2px var(--ok) inset; }
  .bad{ box-shadow:0 0 0 2px var(--warning) inset; }

  /* Panel de comandos */
  .commands{
    margin-top:12px;
    display:grid; grid-template-columns: repeat(4, minmax(70px, 1fr));
    gap:10px;
  }
  .cmd{
    display:flex; flex-direction:column; align-items:center; justify-content:center; gap:6px;
    border:2px solid #3459e6;
    background:#0b1c49; color:#e7f3ff; border-radius:16px; padding:12px 10px;
    user-select:none; touch-action:none; cursor:grab;
  }
  .cmd:active{ cursor:grabbing; }
  .cmd .ico{ font-size:28px; }
  .cmd .lbl{ font-size:12px; text-align:center; color:#cde3ff; }
  .cmd.selected{ outline:3px solid var(--accent); }

  /* M√≥dulo de entrada de c√≥digo (Puerta) */
  .code-panel{
    display:none; margin-top:10px; padding:10px; border:1px solid #2a4bb2; border-radius:12px; background:#0c1c48;
  }
  .colors{ display:flex; gap:8px; margin:8px 0;}
  .color-btn{
    width:28px; height:28px; border-radius:50%; border:2px solid #fff; cursor:pointer;
  }
  .seq{ display:flex; gap:6px; }
  .dot{ width:18px; height:18px; border-radius:50%; border:1px solid #eee; background:#1a2a6a; }

  /* ====== SCENE: FINAL ====== */
  .final-wrap{
    display:grid; gap:16px;
    grid-template-columns: 1fr .9fr;
  }
  @media (max-width:900px){ .final-wrap{ grid-template-columns:1fr; } }
  .celebrate{
    display:grid; place-items:center; min-height:260px;
    border:1px solid #2a4bb2; background: radial-gradient(600px 240px at 70% -10%, #12306f 0%, #0b1638 60%);
    border-radius:18px; position:relative; overflow:hidden;
  }
  .confetti{ position:absolute; inset:0; pointer-events:none; }
  .final-phrase{
    font-size: clamp(18px, 3.5vw, 28px);
    text-align:center; color:#d8f7ff;
  }
  .medals{ display:flex; gap:10px; flex-wrap:wrap; }
  .medal{
    padding:8px 12px; border-radius:999px; font-weight:700;
    border:1px solid #224; background:#0b1a44;
  }
  .m-gold{ border-color: #6e5600; background: linear-gradient(90deg, #a07a00, #ffd54a); color:#1c1400; }
  .m-silver{ border-color:#5a5f63; background: linear-gradient(90deg, #7b8a95,#cfd8dc); color:#0e1418;}
  .m-bronze{ border-color:#6b4320; background: linear-gradient(90deg, #8a5a2b, #d79a6a); color:#140b05;}
  .final-actions{ display:flex; gap:8px; flex-wrap:wrap; }

  /* Accesibilidad visual al arrastrar */
  .drag-ghost{
    position:fixed; z-index:9999; pointer-events:none;
    background:#0b1c49; border:2px solid #4da7ff; border-radius:12px; padding:8px 10px;
    display:flex; gap:8px; align-items:center; font-weight:700;
    box-shadow: var(--shadow);
  }

  /* Peque√±os textos de ayuda */
  .sr-only{
    position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;
  }
</style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <span class="badge" aria-live="polite">Ciudadan√≠a Digital ¬∑ IA y Trabajo en Equipo</span>
      <div class="toggles" role="group" aria-label="Preferencias de accesibilidad y audio">
        <button id="btnNarrar" class="toggle" aria-pressed="true" title="Narraci√≥n por voz">Narraci√≥n: ON</button>
        <button id="btnSonido" class="toggle" aria-pressed="true" title="Sonidos del juego">Sonido: ON</button>
        <button id="btnReiniciar" class="toggle" title="Reiniciar misi√≥n">Reiniciar</button>
      </div>
    </div>

    <!-- =========================
         SCENE: BASE DE MANDO / BRIEFING
         ========================= -->
    <section id="scene-briefing" class="scene active" aria-labelledby="briefing-title">
      <div class="card">
        <h1 id="briefing-title" class="title">Base de Mando ¬∑ <span style="color:var(--accent)">Briefing</span></h1>
        <p class="subtitle">Objetivo: Reconocer qu√© tareas son ideales para IA y cu√°les requieren el toque humano.</p>

        <div class="briefing-grid" role="dialog" aria-label="Briefing inicial con la Jefa de Operaciones">
          <div class="ops-chief" aria-live="polite">
            <div class="ops-avatar" aria-hidden="true">üõ∞Ô∏è</div>
            <div class="ops-speech">
              <strong>Jefa de Operaciones:</strong>
              <div id="briefing-text">
                Bienvenido/a, Comandante. Este es <strong>Bolt</strong>, nuestro robot de rescate impulsado por IA.
                Trabajar√°n en equipo para rescatar a un Fuzzly atrapado en zona de desastre.
              </div>
            </div>
          </div>

          <div>
            <h3>Habilidades</h3>
            <div class="ability-list" aria-describedby="habilidades-desc">
              <span id="habilidades-desc" class="sr-only">Lista de habilidades de Bolt y humanas</span>
              <div class="chip">ü§ñ <strong>De Bolt (IA):</strong> Fuerza, resistencia al fuego, escaneo r√°pido.</div>
              <div class="chip">üßë <strong>Humanas:</strong> Empat√≠a, consuelo, cuidado emocional.</div>
            </div>
            <button class="cta" id="btnComenzar">¬°Comenzar Misi√≥n!</button>
            <p style="margin-top:8px;color:#c8e7ff">
              Usa la habilidad correcta para cada obst√°culo y <em>rescata al Fuzzly</em>.
            </p>
          </div>
        </div>
      </div>
    </section>

    <!-- =========================
         SCENE: JUEGO ‚Äî VISTA LATERAL
         ========================= -->
    <section id="scene-game" class="scene" aria-labelledby="game-title">
      <div class="card">
        <h2 id="game-title" class="title">Zona de Desastre ¬∑ <span style="color:var(--accent-2)">Operaci√≥n Rescate</span></h2>

        <!-- HUD Superior -->
        <div class="hud" aria-live="polite">
          <div class="robot-pill" id="boltInfo" title="Estado de Bolt">
            <div class="robot-emoji" id="boltFace" aria-hidden="true">ü§ñ</div>
            <div>
              <div><strong>Bolt</strong> ¬∑ IA de Rescate</div>
              <small id="boltState" style="color:#bfefff">Listo</small>
            </div>
          </div>
          <div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" aria-label="Progreso de la misi√≥n">
            <span id="progressBar"></span>
          </div>
          <div class="hint" id="hint">Arrastra un comando sobre el objetivo correcto, en orden.</div>
        </div>

        <!-- Campo de juego: 4 columnas (obst√°culos en orden) -->
        <div class="playfield" id="playfield" aria-label="Vista lateral del terreno con obst√°culos">
          <!-- 1) Derrumbe -->
          <div class="obstacle droppable" id="obs1" data-need="brute" tabindex="0" aria-label="Derrumbe de rocas. Requiere Fuerza Bruta">
            <h4>1. Derrumbe</h4>
            <div class="body" aria-hidden="true">ü™®ü™®ü™®</div>
          </div>

          <!-- 2) Muro de Fuego (requiere activar anti-fuego en Bolt, luego pasa y apaga) -->
          <div class="obstacle droppable" id="obs2" data-need="fire" tabindex="0" aria-label="Muro de fuego. Activa Modo Anti-fuego en Bolt">
            <h4>2. Muro de Fuego</h4>
            <div class="body" aria-hidden="true">üî•üî•üî•</div>
          </div>

          <!-- 3) Puerta Codificada con manual escaneable -->
          <div class="obstacle droppable" id="obs3" data-need="scan" tabindex="0" aria-label="Puerta codificada. Usa esc√°ner sobre el manual para revelar el c√≥digo">
            <h4>3. Puerta Codificada</h4>
            <div class="body" aria-hidden="true">üö™üîí</div>
            <div id="manual" class="chip" style="position:absolute; right:8px; bottom:8px; cursor:help;" title="Manual de Puerta">
              üìò Manual
            </div>
            <div id="codePanel" class="code-panel" aria-live="polite">
              <div><strong>C√≥digo de colores:</strong> <span id="codeDisplay"></span></div>
              <div class="colors" aria-label="Ingrese el c√≥digo tocando los colores en orden">
                <button class="color-btn" data-color="r" style="background:#ff1744" aria-label="Rojo"></button>
                <button class="color-btn" data-color="g" style="background:#00e676" aria-label="Verde"></button>
                <button class="color-btn" data-color="b" style="background:#2979ff" aria-label="Azul"></button>
                <button class="color-btn" data-color="y" style="background:#ffd600" aria-label="Amarillo"></button>
              </div>
              <div class="seq" id="enteredSeq" aria-label="Secuencia ingresada"></div>
            </div>
          </div>

          <!-- 4) Rescate Emocional (Fuzzly) -->
          <div class="ally droppable" id="obs4" data-need="hug" tabindex="0" aria-label="Fuzzly asustado. Requiere Abrazo Humano">
            <h4>4. Fuzzly</h4>
            <div class="body" id="fuzzly" aria-hidden="true">üß∏üò∞</div>
          </div>
        </div>

        <!-- Men√∫ de comandos (draggables + tap-select en m√≥vil) -->
        <div class="commands" role="toolbar" aria-label="Men√∫ de comandos">
          <div class="cmd" draggable="true" data-cmd="brute" id="cmd-brute" aria-label="Fuerza Bruta" tabindex="0">
            <div class="ico">üí™</div><div class="lbl">Fuerza Bruta</div>
          </div>
          <div class="cmd" draggable="true" data-cmd="fire" id="cmd-fire" aria-label="Modo Anti-fuego" tabindex="0">
            <div class="ico">üî•</div><div class="lbl">Modo Anti-fuego</div>
          </div>
          <div class="cmd" draggable="true" data-cmd="scan" id="cmd-scan" aria-label="Esc√°ner de Largo Alcance" tabindex="0">
            <div class="ico">üì°</div><div class="lbl">Esc√°ner</div>
          </div>
          <div class="cmd" draggable="true" data-cmd="hug" id="cmd-hug" aria-label="Abrazo Humano" tabindex="0">
            <div class="ico">ü§ó</div><div class="lbl">Abrazo Humano</div>
          </div>
        </div>
      </div>
    </section>

    <!-- =========================
         SCENE: FINAL
         ========================= -->
    <section id="scene-final" class="scene" aria-labelledby="final-title">
      <div class="card">
        <h2 id="final-title" class="title">Operaci√≥n Completa ¬∑ <span style="color:var(--ok)">¬°Rescate Exitoso!</span></h2>

        <div class="final-wrap">
          <div class="celebrate" id="celebrate">
            <div class="confetti" id="confetti"></div>
            <div class="final-phrase" id="finalPhrase">
              ‚Äú¬°La fuerza del robot y el coraz√≥n del humano, juntos resuelven cualquier plano!‚Äù
            </div>
          </div>

          <div>
            <h3>Informe de Misi√≥n</h3>
            <p id="report">Excelente coordinaci√≥n. La IA afront√≥ tareas riesgosas; el humano brind√≥ cuidado emocional.</p>

            <h4>Medallas</h4>
            <div class="medals" id="medals"></div>

            <div class="final-actions">
              <button class="toggle" id="btnNueva">Nueva Misi√≥n (rejugar)</button>
              <button class="toggle" id="btnSkin">Conmutar Estilo de Bolt</button>
            </div>

            <p class="subtitle" style="margin-top:10px">
              Pr√≥ximos escenarios (rejugabilidad): <strong>Submarino</strong>, <strong>Estaci√≥n Espacial</strong>. <em>(Pr√≥ximamente)</em>
            </p>
          </div>
        </div>
      </div>
    </section>
  </div>

<script>
/* ================================================================
   EQUIPO IA: MISI√ìN RESCATE ‚Äî L√ìGICA DEL JUEGO (JavaScript puro)
   Organizaci√≥n por secciones:
   1) Utilidades (audio, voz, accesibilidad)
   2) Estado y referencia de UI
   3) Navegaci√≥n entre escenas
   4) Mec√°nica de comandos (drag & drop + soporte t√°ctil y teclado)
   5) Reglas de obst√°culos y feedback
   6) Puerta Codificada (mini puzzle de colores)
   7) Final de misi√≥n, medallas y ‚Äúskins‚Äù de Bolt
==================================================================*/

/* -----------------------------------------
   1) UTILIDADES: AUDIO (WebAudio) + VOZ
------------------------------------------ */
const AudioCtx = window.AudioContext || window.webkitAudioContext;
let audioCtx = null;
let sonidosOn = true;
function ensureAudio(){
  if(!audioCtx) audioCtx = new AudioCtx();
}
function beep(freq=660, dur=0.12, type='sine', gain=0.05){
  if(!sonidosOn) return;
  ensureAudio();
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = type; o.frequency.value = freq;
  g.gain.value = gain;
  o.connect(g).connect(audioCtx.destination);
  o.start();
  o.stop(audioCtx.currentTime + dur);
}
function chord(freqs=[523,659,783], dur=0.2){
  if(!sonidosOn) return;
  ensureAudio();
  const now = audioCtx.currentTime;
  freqs.forEach(f=>{
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type='triangle'; o.frequency.value=f;
    g.gain.value = 0.035;
    o.connect(g).connect(audioCtx.destination);
    o.start(now);
    o.stop(now+dur);
  });
}

let narrarOn = true;
function speak(text){
  if(!narrarOn || !('speechSynthesis' in window)) return;
  const utter = new SpeechSynthesisUtterance(text);
  // Preferir una voz en espa√±ol si existe
  const voices = speechSynthesis.getVoices();
  const es = voices.find(v => /es-/.test(v.lang)) || voices.find(v=>v.lang.startsWith('es')) || voices[0];
  if(es) utter.voice = es;
  utter.rate = 1; utter.pitch = 1; utter.volume = 1;
  speechSynthesis.cancel(); // evita solapamiento
  speechSynthesis.speak(utter);
}

/* -----------------------------------------
   2) ESTADO Y REFERENCIAS
------------------------------------------ */
const qs = sel => document.querySelector(sel);
const qsa = sel => [...document.querySelectorAll(sel)];

// Escenas
const sceneBriefing = qs('#scene-briefing');
const sceneGame = qs('#scene-game');
const sceneFinal = qs('#scene-final');

// HUD
const boltState = qs('#boltState');
const progressBar = qs('#progressBar');
const hint = qs('#hint');
const boltFace = qs('#boltFace');

// Obst√°culos (en orden)
const obstacles = [
  { id:'obs1', need:'brute', name:'Derrumbe' },
  { id:'obs2', need:'fire',  name:'Muro de Fuego' },
  { id:'obs3', need:'scan',  name:'Puerta Codificada' },
  { id:'obs4', need:'hug',   name:'Rescate Emocional' },
];

let currentStep = 0; // √≠ndice del obst√°culo actual
let errores = 0;     // contador de errores para medallas
let acciones = 0;    // acciones totales

// Puerta codificada
const manual = qs('#manual');
const codePanel = qs('#codePanel');
const codeDisplay = qs('#codeDisplay');
const enteredSeq = qs('#enteredSeq');
const colorBtns = qsa('.color-btn');
let codeSecret = [];  // ej. ['r','g','b']
let codeEntered = [];

// Preferencias
const btnNarrar = qs('#btnNarrar');
const btnSonido = qs('#btnSonido');
const btnReiniciar = qs('#btnReiniciar');

// Comandos
const cmds = qsa('.cmd');
let selectedCmd = null;         // para soporte t√°ctil / teclado
let draggingGhost = null;       // elemento visual durante drag manual

// Final
const medalsWrap = qs('#medals');
const report = qs('#report');
const btnNueva = qs('#btnNueva');
const btnSkin = qs('#btnSkin');
const confetti = qs('#confetti');

/* -----------------------------------------
   3) NAVEGACI√ìN ENTRE ESCENAS
------------------------------------------ */
function showScene(id){
  [sceneBriefing, sceneGame, sceneFinal].forEach(s=>s.classList.remove('active'));
  qs('#'+id).classList.add('active');
  window.scrollTo({top:0, behavior:'smooth'});
}

function startBriefing(){
  showScene('scene-briefing');
  speak("Bienvenido, Comandante. Este es Bolt, robot de rescate. Usen la habilidad correcta en cada obst√°culo y salven al Fuzzly.");
}

function startGame(){
  // Estado inicial
  currentStep = 0; errores = 0; acciones = 0;
  progressBar.style.width = '0%';
  boltFace.textContent = 'ü§ñ';
  boltState.textContent = 'Listo';
  hint.textContent = 'Arrastra un comando sobre el objetivo correcto, en orden.';
  // Reset puerta
  codeSecret = []; codeEntered = [];
  codePanel.style.display = 'none';
  codeDisplay.textContent = '';
  enteredSeq.innerHTML = '';
  // Reset visual de obst√°culos
  obstacles.forEach(o=>{
    const el = qs('#'+o.id);
    el.classList.remove('ok','bad');
    // Restaurar contenido visual clave
    if(o.id==='obs1') el.querySelector('.body').textContent='ü™®ü™®ü™®';
    if(o.id==='obs2') el.querySelector('.body').textContent='üî•üî•üî•';
    if(o.id==='obs3') el.querySelector('.body').textContent='üö™üîí';
    if(o.id==='obs4'){ qs('#fuzzly').textContent='üß∏üò∞'; }
  });

  showScene('scene-game');
  speak("Iniciando misi√≥n. Sigue el orden de los obst√°culos y escoge el poder adecuado.");
}

// Final de misi√≥n
function finishMission(){
  showScene('scene-final');
  spawnConfetti(80);
  chord([523,659,783], .35);
  speak("¬°Misi√≥n cumplida! El calor humano es insustituible, y la IA es poderosa en tareas riesgosas.");
  renderMedals();
}

/* -----------------------------------------
   4) MEC√ÅNICA DE COMANDOS (Drag & Drop + t√°ctil + teclado)
------------------------------------------ */

/* Accesibilidad: click/tap para seleccionar un comando y luego tocar el destino */
cmds.forEach(cmd=>{
  // Accesible: click seleccionar
  cmd.addEventListener('click', ()=>{
    toggleSelect(cmd);
  });
  cmd.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter' || e.key === ' '){
      e.preventDefault(); toggleSelect(cmd);
    }
  });

  // Desktop drag & drop nativo
  cmd.addEventListener('dragstart', (e)=>{
    e.dataTransfer.setData('text/plain', cmd.dataset.cmd);
    e.dataTransfer.effectAllowed = 'copy';
    makeGhost(cmd);
  });
  cmd.addEventListener('dragend', ()=>{
    removeGhost();
  });

  // Soporte t√°ctil manual (pointer events)
  cmd.addEventListener('pointerdown', (e)=>{
    if(e.pointerType === 'touch'){ beginManualDrag(cmd, e); }
  }, {passive:true});
});

function toggleSelect(cmd){
  if(selectedCmd === cmd){ cmd.classList.remove('selected'); selectedCmd=null; return; }
  cmds.forEach(c=>c.classList.remove('selected'));
  selectedCmd = cmd; cmd.classList.add('selected');
  hint.textContent = `Comando seleccionado: ${labelFor(cmd.dataset.cmd)}. Toca el objetivo.`;
  beep(760, .06, 'square', .03);
}

function labelFor(cmd){
  return ({
    brute:'Fuerza Bruta üí™',
    fire:'Modo Anti-fuego üî•',
    scan:'Esc√°ner de Largo Alcance üì°',
    hug:'Abrazo Humano ü§ó'
  })[cmd] || cmd;
}

// Hacer droppables accesibles a click/tap con comando seleccionado
qsa('.droppable').forEach(zone=>{
  // Soporta drop nativo
  zone.addEventListener('dragover', (e)=>{ e.preventDefault(); zone.classList.add('droppable'); });
  zone.addEventListener('dragleave', ()=> zone.classList.remove('droppable'));
  zone.addEventListener('drop', (e)=>{
    e.preventDefault();
    const cmd = e.dataTransfer.getData('text/plain');
    zone.classList.remove('droppable');
    applyCommand(cmd, zone.id);
  });

  // Click/tap con selecci√≥n previa
  zone.addEventListener('click', ()=>{
    if(selectedCmd){
      applyCommand(selectedCmd.dataset.cmd, zone.id);
    }
  });
});

/* Drag t√°ctil manual (crea un ‚Äúghost‚Äù que sigue el dedo) */
let manualDragging = null;
function beginManualDrag(cmd, e){
  manualDragging = { cmd, id: cmd.dataset.cmd };
  makeGhost(cmd);
  moveGhost(e.clientX, e.clientY);
  window.addEventListener('pointermove', onManualMove, {passive:false});
  window.addEventListener('pointerup', onManualUp, {once:true});
}
function onManualMove(e){
  if(!manualDragging) return;
  e.preventDefault();
  moveGhost(e.clientX, e.clientY);
}
function onManualUp(e){
  if(!manualDragging) return;
  const el = document.elementFromPoint(e.clientX, e.clientY);
  const dropZone = el?.closest('.droppable');
  if(dropZone){
    applyCommand(manualDragging.id, dropZone.id);
  }else{
    beep(220, .08, 'sawtooth', .04);
  }
  manualDragging=null; removeGhost();
  window.removeEventListener('pointermove', onManualMove);
}
function makeGhost(cmd){
  removeGhost();
  draggingGhost = document.createElement('div');
  draggingGhost.className = 'drag-ghost';
  draggingGhost.innerHTML = `<span>${cmd.querySelector('.ico').textContent}</span> <span>${labelFor(cmd.dataset.cmd)}</span>`;
  document.body.appendChild(draggingGhost);
}
function moveGhost(x,y){
  if(!draggingGhost) return;
  draggingGhost.style.left = (x+8)+'px';
  draggingGhost.style.top  = (y+8)+'px';
}
function removeGhost(){
  draggingGhost?.remove(); draggingGhost=null;
}

/* -----------------------------------------
   5) REGLAS DE OBST√ÅCULOS Y FEEDBACK
------------------------------------------ */
function applyCommand(cmd, zoneId){
  acciones++;

  const obstacle = obstacles[currentStep];
  const expectedZoneId = obstacle?.id;
  if(zoneId !== expectedZoneId){
    errorFeedback("Debes resolver los obst√°culos en orden.");
    return;
  }

  if(cmd !== obstacle.need){
    // Caso especial: Muro de Fuego requiere aplicar ‚Äúfire‚Äù SOBRE BOLT, no sobre el fuego.
    if(obstacle.need === 'fire' && cmd === 'fire'){
      // Permitir que el jugador tambi√©n ‚Äúactive‚Äù el modo anti-fuego tocando el propio Bolt en HUD
      boltState.textContent = 'Anti-fuego activado';
      okFeedbackIA("¬°Orden recibida! Bolt puede cruzar el fuego.");
      // Animaci√≥n de apagado
      setTimeout(()=>{
        qs('#'+expectedZoneId).querySelector('.body').textContent='üíßüíßüíß';
        advance();
      }, 450);
      return;
    }
    errorFeedback("Ese no es el poder que necesitamos aqu√≠.");
    return;
  }

  // √âxito seg√∫n tipo
  switch(cmd){
    case 'brute': { // Derrumbe
      okFeedbackIA("¬°Orden recibida! La habilidad de Bolt resolvi√≥ el problema.");
      const body = qs('#'+zoneId).querySelector('.body');
      body.textContent = 'üß±‚û°Ô∏è  ‚úÖ';
      setTimeout(()=>advance(), 400);
      break;
    }
    case 'fire': { // Muro de Fuego -> tambi√©n permitimos si lo solt√≥ sobre el muro
      boltState.textContent = 'Anti-fuego activado';
      okFeedbackIA("¬°Orden recibida! Bolt atraves√≥ las llamas y apag√≥ el fuego.");
      const body = qs('#'+zoneId).querySelector('.body');
      body.textContent = 'üíßüíßüíß  ‚úÖ';
      setTimeout(()=>advance(), 400);
      break;
    }
    case 'scan': { // Puerta Codificada -> revelar c√≥digo y esperar entrada
      okFeedbackIA("Escaneo completado. C√≥digo de colores listo.");
      revealCode();
      // Avance ocurre tras validar la secuencia
      break;
    }
    case 'hug': { // Rescate emocional
      warmFeedbackHumano("¬°El calor humano es un poder que ninguna IA puede replicar!");
      qs('#fuzzly').textContent = 'üß∏üòä';
      boltFace.textContent = 'ü§ñüëç';
      setTimeout(()=>advance(), 600);
      break;
    }
  }
}

function okFeedbackIA(text){
  qs('#'+obstacles[currentStep].id).classList.add('ok');
  chord([660,880,1046], .22);
  speak(text);
}
function errorFeedback(text){
  errores++;
  const el = qs('#'+obstacles[currentStep].id);
  el.classList.add('bad');
  setTimeout(()=>el.classList.remove('bad'), 300);
  beep(180, .12, 'square', .05);
  speak(text);
}
function warmFeedbackHumano(text){
  chord([392,523,659], .28);
  speak(text);
}

function advance(){
  currentStep++;
  const pct = Math.round((currentStep / obstacles.length)*100);
  progressBar.style.width = pct+'%';
  hint.textContent = currentStep < obstacles.length
    ? `Buen trabajo. Siguiente: ${obstacles[currentStep].name}.`
    : '¬°Objetivo asegurado!';
  if(currentStep >= obstacles.length){
    setTimeout(finishMission, 650);
  }
}

/* -----------------------------------------
   6) PUERTA CODIFICADA (Esc√°ner + Secuencia)
------------------------------------------ */
// Revelar c√≥digo al escanear el manual (tambi√©n permite ‚Äúsoltar‚Äù scan encima del manual)
manual.addEventListener('click', ()=>{
  // Si estamos en el paso de la puerta y el jugador toc√≥ el manual sin ‚Äúscan‚Äù seleccionado, damos pista.
  if(currentStep===2){
    speak("Usa el esc√°ner de largo alcance sobre el manual para revelar el c√≥digo.");
    hint.textContent = "Pista: selecciona üì° y toca el manual.";
  }
});

// Cuando el jugador usa ‚Äúscan‚Äù correctamente en la puerta, llamamos:
function revealCode(){
  if(currentStep!==2) return;
  // Generar una secuencia aleatoria de 3 colores
  const pool = ['r','g','b','y'];
  codeSecret = Array.from({length:3}, ()=> pool[Math.floor(Math.random()*pool.length)]);
  codeDisplay.innerHTML = codeSecret.map(c => colorDot(c, true)).join(' ');
  codePanel.style.display = 'block';
  enteredSeq.innerHTML = '';
  codeEntered = [];
  hint.textContent = 'Introduce el c√≥digo de colores en el panel.';
}
function colorDot(c, show){
  const map = {r:'#ff1744', g:'#00e676', b:'#2979ff', y:'#ffd600'};
  const style = `display:inline-block;width:16px;height:16px;border-radius:50%;border:1px solid #fff;background:${show?map[c]:'#1a2a6a'};`;
  return `<span style="${style}" aria-hidden="true"></span>`;
}
colorBtns.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    if(currentStep!==2) return;
    const c = btn.dataset.color;
    codeEntered.push(c);
    const dot = document.createElement('div');
    dot.className='dot';
    dot.style.background = btn.style.background;
    enteredSeq.appendChild(dot);
    if(codeEntered.length===codeSecret.length){
      // Validar
      if(codeEntered.join('') === codeSecret.join('')){
        okFeedbackIA("C√≥digo correcto. Puerta desbloqueada.");
        qs('#obs3').querySelector('.body').textContent='üö™‚úÖ';
        setTimeout(()=>advance(), 500);
      }else{
        errorFeedback("C√≥digo incorrecto. Intenta de nuevo.");
        codeEntered=[]; enteredSeq.innerHTML='';
      }
    }
  });
});

/* -----------------------------------------
   7) FINAL, MEDALLAS Y SKINS
------------------------------------------ */
function renderMedals(){
  medalsWrap.innerHTML = '';
  // M√©trica simple de eficiencia: errores
  let medalClass = 'm-gold', medalText = 'Oro ‚Äî Eficiencia Excelente';
  if(errores >= 1 && errores <=2){ medalClass = 'm-silver'; medalText='Plata ‚Äî Buen Trabajo'; }
  if(errores >= 3){ medalClass = 'm-bronze'; medalText='Bronce ‚Äî Perseverancia'; }

  const m = document.createElement('div');
  m.className = `medal ${medalClass}`;
  m.textContent = medalText + ` (Errores: ${errores})`;
  medalsWrap.appendChild(m);

  report.textContent = errores === 0
    ? "Coordinaci√≥n perfecta: decisiones precisas y uso √≥ptimo de la IA."
    : "Buen liderazgo: la IA resolvi√≥ tareas riesgosas y t√∫ brindaste apoyo humano.";

  // ‚ÄúMejora cosm√©tica‚Äù de Bolt: si oro, activar ‚Äúskin luminosa‚Äù autom√°ticamente
  if(medalClass==='m-gold'){
    setBoltSkin('luminous');
  }else{
    setBoltSkin('default');
  }
}

let boltSkin = 'default';
function setBoltSkin(mode){
  boltSkin = mode;
  const pill = qs('#boltInfo');
  if(mode==='luminous'){
    pill.style.borderColor = '#22ffd2';
    pill.style.background = 'linear-gradient(90deg,#0b1a44,#0a3a5a)';
    boltFace.textContent = 'ü§ñ‚ú®';
  }else{
    pill.style.borderColor = '#3554c7';
    pill.style.background = '#0b1a44';
    boltFace.textContent = 'ü§ñ';
  }
}

function spawnConfetti(n=60){
  confetti.innerHTML = '';
  for(let i=0;i<n;i++){
    const c = document.createElement('div');
    const size = 6 + Math.random()*8;
    c.style.position='absolute';
    c.style.left = Math.random()*100 + '%';
    c.style.top = -10+'px';
    c.style.width=size+'px';
    c.style.height=size+'px';
    c.style.background = ['#00ffa8','#00e0ff','#ffd54a','#ff7aa2'][Math.floor(Math.random()*4)];
    c.style.opacity = .9;
    c.style.transform = `rotate(${Math.random()*360}deg)`;
    c.style.borderRadius = Math.random()>.7 ? '50%' : '2px';
    confetti.appendChild(c);

    const fall = 800 + Math.random()*900;
    c.animate([
      { transform: c.style.transform, top: '-10px' },
      { transform: `rotate(${Math.random()*720}deg)`, top: '105%' }
    ], { duration: fall, easing: 'ease-in', fill: 'forwards' });
  }
}

/* -----------------------------------------
   EVENTOS DE UI GLOBALES
------------------------------------------ */
// Botones de topbar
btnNarrar.addEventListener('click', ()=>{
  narrarOn = !narrarOn;
  btnNarrar.setAttribute('aria-pressed', String(narrarOn));
  btnNarrar.textContent = 'Narraci√≥n: ' + (narrarOn?'ON':'OFF');
  if(narrarOn) speak("Narraci√≥n activada.");
});
btnSonido.addEventListener('click', ()=>{
  sonidosOn = !sonidosOn;
  btnSonido.setAttribute('aria-pressed', String(sonidosOn));
  btnSonido.textContent = 'Sonido: ' + (sonidosOn?'ON':'OFF');
  if(sonidosOn) beep(760,.06,'square',.03);
});
btnReiniciar.addEventListener('click', ()=>{ startGame(); });

// CTA de briefing
qs('#btnComenzar').addEventListener('click', ()=>{
  startGame();
  // Narraci√≥n guiada del briefing/entrenamiento
  setTimeout(()=>{
    speak("Recuerda: Usa Fuerza Bruta para el derrumbe. Activa anti fuego para cruzar llamas. Escanea el manual para abrir la puerta. Y da un abrazo humano al Fuzzly.");
  }, 300);
});

// Final
btnNueva.addEventListener('click', ()=> startGame());
btnSkin.addEventListener('click', ()=>{
  setBoltSkin(boltSkin==='default' ? 'luminous' : 'default');
});

/* -----------------------------------------
   ACCESIBILIDAD: Anunciar instrucciones iniciales
------------------------------------------ */
window.addEventListener('load', ()=>{
  // iOS requiere interacci√≥n para audio, pero el motor de voz puede funcionar tras carga.
  startBriefing();
  // Cargar voces para SpeechSynthesis (algunos navegadores necesitan evento)
  if('speechSynthesis' in window){
    window.speechSynthesis.onvoiceschanged = ()=>{};
  }
});
</script>
</body>
</html>
