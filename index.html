<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Equipo IA: Misi√≥n Rescate</title>

<style>
  :root {
    --bg: #0b1020;
    --accent: #00e0ff;
    --accent-2: #19ff84;
    --warning: #ff385c;
    --text: #f5fbff;
    --muted: #b6c7d9;
    --card: #111a36;
  }

  * { box-sizing: border-box; }
  body {
    margin: 0; font-family: 'Segoe UI', sans-serif;
    color: var(--text); background: var(--bg);
    height: 100vh; display: flex; justify-content: center; align-items: center;
    overflow: hidden;
  }

  #game-container {
    width: 100%; max-width: 1024px; height: 98vh;
    background: rgba(15, 23, 48, 0.95);
    border: 3px solid #1b2b6b; border-radius: 20px;
    position: relative; display: flex; flex-direction: column;
    box-shadow: 0 0 40px rgba(0,0,0,0.8);
  }

  .scene { display: none; flex-direction: column; height: 100%; padding: 20px; animation: fadeIn 0.4s; }
  .scene.active { display: flex; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

  .audio-btn {
    position: absolute; top: 15px; right: 15px; z-index: 1100;
    background: #1a2d6b; border: 2px solid var(--accent);
    color: var(--accent); width: 40px; height: 40px; border-radius: 50%;
    cursor: pointer; font-size: 18px;
  }

  .hud {
    display: flex; justify-content: space-between; align-items: center;
    padding: 10px 20px; background: #070d1f; border-radius: 10px; margin-bottom: 10px;
    z-index: 10;
  }
  .timer { font-family: monospace; font-size: 24px; color: var(--warning); background: #000; padding: 2px 10px; border-radius: 5px; border: 1px solid var(--warning); }

  .playfield {
    flex: 1; display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;
    padding: 10px; background: rgba(0,0,0,0.3); border-radius: 15px; align-items: stretch;
  }
  .obstacle {
    border: 2px dashed #24418f; border-radius: 15px;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    position: relative; background: rgba(12, 26, 64, 0.6); transition: 0.3s;
    text-align: center; padding: 10px;
  }
  .obstacle.active-step { border-color: var(--accent); background: rgba(0, 224, 255, 0.1); box-shadow: 0 0 15px var(--accent); }
  .obstacle.completed { border: 2px solid var(--accent-2); background: rgba(25, 255, 132, 0.1); }
  
  .obs-icon { font-size: 50px; margin: 10px 0; }
  .obs-label { font-size: 12px; font-weight: bold; color: var(--muted); margin-bottom: 5px; }

  /* PUZZLE DE COLORES - CORRECCI√ìN DE CAPAS */
  #door-puzzle {
    display: none; background: #0c1c48; padding: 15px; border-radius: 12px;
    border: 2px solid var(--accent); position: absolute; top: 0; left: 0; right: 0; bottom: 0;
    z-index: 50; flex-direction: column; justify-content: center; align-items: center;
    pointer-events: auto;
  }
  .target-seq { display: flex; justify-content: center; gap: 10px; margin: 10px 0; padding: 10px; background: #000; border-radius: 8px; }
  .dot-target { width: 30px; height: 30px; border-radius: 50%; border: 2px solid #fff; }
  
  .color-btn { width: 45px; height: 45px; border-radius: 50%; border: 3px solid #fff; cursor: pointer; margin: 5px; position: relative; z-index: 60; }

  .command-bar {
    height: 120px; display: flex; justify-content: center; gap: 20px;
    padding: 15px; background: #0f1730; border-top: 2px solid #1b2b6b;
    z-index: 10;
  }
  .cmd {
    width: 95px; background: #1a2d6b; border: 2px solid var(--accent); border-radius: 15px;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    cursor: grab; transition: 0.2s; user-select: none;
  }
  .cmd.selected { border-color: var(--accent-2); background: #224a85; box-shadow: 0 0 10px var(--accent-2); }
  .cmd .ico { font-size: 32px; }
  .cmd .lbl { font-size: 10px; color: white; margin-top: 5px; font-weight: bold; }

  .chief-overlay {
    position: absolute; top: 75px; left: 50%; transform: translateX(-50%);
    width: 90%; max-width: 600px;
    background: rgba(5, 10, 24, 0.98); padding: 15px; border-radius: 15px;
    border: 2px solid var(--accent); display: flex; align-items: center; gap: 15px;
    opacity: 0; pointer-events: none; transition: 0.4s; z-index: 1000;
  }
  .chief-overlay.visible { opacity: 1; }
  .chief-avatar { width: 60px; height: 60px; background: #1a2d6b; border-radius: 50%; display: grid; place-items: center; font-size: 30px; border: 2px solid var(--accent); }

  .btn-main {
    background: linear-gradient(135deg, var(--accent), #0078ff);
    color: white; border: none; padding: 18px 40px; font-size: 22px;
    font-weight: bold; border-radius: 50px; cursor: pointer; transition: 0.3s;
  }
</style>
</head>
<body>

<button class="audio-btn" id="btn-mute">üîä</button>

<div id="game-container">
  
  <!-- ESCENA 1: SPLASH -->
  <section id="scene-splash" class="scene active" style="justify-content: center; align-items: center; text-align: center;">
    <div style="font-size: 80px; margin-bottom: 10px;">ü§ñüõ°Ô∏è‚ù§Ô∏è</div>
    <h1 style="color: var(--accent); font-size: 42px; margin: 0;">EQUIPO IA: MISI√ìN RESCATE</h1>
    <p style="color: var(--muted); margin-bottom: 30px;">Combina la potencia de la IA con el coraz√≥n humano.</p>
    <button class="btn-main" id="btn-to-briefing">INICIAR BRIEFING</button>
  </section>

  <!-- ESCENA 2: BRIEFING -->
  <section id="scene-briefing" class="scene">
    <div style="background: var(--card); border-radius: 15px; padding: 30px; border-bottom: 5px solid var(--accent); flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;">
      <div style="font-size:60px; margin-bottom: 20px;">üë©‚ÄçüöÄ</div>
      <h2 style="color:var(--accent);">SALA DE ENTRENAMIENTO</h2>
      <p id="briefing-text" style="font-size: 20px; max-width: 700px; line-height: 1.6;"></p>
    </div>
    <div style="text-align: center; padding-top: 20px;">
      <button class="btn-main" id="btn-start-mission">¬°EMPEZAR RESCATE!</button>
    </div>
  </section>

  <!-- ESCENA 3: JUEGO -->
  <section id="scene-game" class="scene">
    <div class="chief-overlay" id="chief-speech">
      <div class="chief-avatar">üë©‚ÄçüöÄ</div>
      <div id="speech-text" style="font-size: 16px; font-weight: bold; color: #fff;"></div>
    </div>

    <div class="hud">
      <div style="display:flex; align-items:center; gap:10px;">
        <div style="font-size:25px;">üõ∞Ô∏è</div>
        <div>MISION: <span id="mission-status" style="color:var(--accent-2)">ACTIVA</span></div>
      </div>
      <div class="timer" id="timer-display">01:00</div>
      <div style="width:150px; height:10px; background:#000; border-radius:5px; border:1px solid #333;">
        <div id="prog-bar" style="width:0%; height:100%; background:var(--accent-2); transition:0.3s;"></div>
      </div>
    </div>

    <div class="playfield">
      <div class="obstacle" id="obs-0" data-need="brute">
        <div class="obs-label">1. DERRUMBE</div>
        <div class="obs-icon" id="icon-0">ü™®</div>
      </div>
      <div class="obstacle" id="obs-1" data-need="fire">
        <div class="obs-label">2. FUEGO</div>
        <div class="obs-icon" id="icon-1">üî•üî•</div>
      </div>
      <div class="obstacle" id="obs-2" data-need="scan">
        <div class="obs-label">3. PUERTA</div>
        <div class="obs-icon" id="icon-2">üö™üîí</div>
        
        <div id="door-puzzle">
          <div style="font-size: 11px; font-weight: bold; color: var(--accent);">C√ìDIGO SECRETO:</div>
          <div class="target-seq" id="code-target"></div>
          <div style="font-size: 11px; font-weight: bold; color: #fff; margin-bottom: 5px;">TOCA LOS COLORES EN ORDEN:</div>
          <div style="display:flex;">
            <button class="color-btn" data-color="r" style="background:#ff1744"></button>
            <button class="color-btn" data-color="g" style="background:#00e676"></button>
            <button class="color-btn" data-color="b" style="background:#2979ff"></button>
          </div>
          <div id="input-dots" style="display:flex; gap:8px; margin-top:15px; height: 15px;"></div>
        </div>
      </div>
      <div class="obstacle" id="obs-3" data-need="hug">
        <div class="obs-label">4. FUZZLY</div>
        <div class="obs-icon" id="icon-3">üò∞</div>
      </div>
    </div>

    <div class="command-bar">
      <div class="cmd" draggable="true" data-type="brute">
        <div class="ico">üí™</div><div class="lbl">FUERZA IA</div>
      </div>
      <div class="cmd" draggable="true" data-type="fire">
        <div class="ico">üõ°Ô∏è</div><div class="lbl">ESCUDO IA</div>
      </div>
      <div class="cmd" draggable="true" data-type="scan">
        <div class="ico">üì°</div><div class="lbl">ESC√ÅNER IA</div>
      </div>
      <div class="cmd" draggable="true" data-type="hug">
        <div class="ico">ü§ó</div><div class="lbl">ABRAZO HUMANO</div>
      </div>
    </div>
  </section>

  <!-- ESCENA 4: FINAL -->
  <section id="scene-final" class="scene" style="justify-content: center; align-items: center; text-align: center;">
    <div style="background: var(--card); padding: 50px; border-radius: 30px; border: 2px solid var(--accent); max-width: 600px;">
      <div id="final-emoji" style="font-size: 90px; margin-bottom: 20px;">üèÜ</div>
      <h1 id="final-title" style="color: var(--accent);">¬°RESCATE EXITOSO!</h1>
      <p id="final-msg" style="font-size: 18px; line-height: 1.5; color: var(--muted); margin-bottom: 30px;"></p>
      <button class="btn-main" id="btn-restart">REINTENTAR</button>
    </div>
  </section>

</div>

<script>
const state = {
  currentStep: 0,
  timer: 60,
  isMuted: false,
  isPaused: true,
  timerInterval: null,
  codeSecret: [],
  codeEntered: [],
  puzzleActive: false
};

const audio = {
  ctx: null,
  init() { if(!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
  beep(freq, dur) {
    if (state.isMuted || !this.ctx) return;
    const o = this.ctx.createOscillator();
    const g = this.ctx.createGain();
    o.frequency.value = freq;
    g.gain.exponentialRampToValueAtTime(0.0001, this.ctx.currentTime + dur);
    o.connect(g).connect(this.ctx.destination);
    o.start(); o.stop(this.ctx.currentTime + dur);
  }
};

function speak(text) {
  const box = document.getElementById('chief-speech');
  const txt = document.getElementById('speech-text');
  txt.innerText = text;
  box.classList.add('visible');

  if (!state.isMuted && 'speechSynthesis' in window) {
    speechSynthesis.cancel();
    const msg = new SpeechSynthesisUtterance(text);
    msg.lang = 'es-ES';
    msg.onend = () => {
      if(!state.puzzleActive) setTimeout(() => box.classList.remove('visible'), 2000);
    };
    speechSynthesis.speak(msg);
  } else {
    if(!state.puzzleActive) setTimeout(() => box.classList.remove('visible'), 5000);
  }
}

function showScene(id) {
  document.querySelectorAll('.scene').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function startTimer() {
  clearInterval(state.timerInterval);
  state.timerInterval = setInterval(() => {
    if (state.isPaused) return;
    state.timer--;
    document.getElementById('timer-display').innerText = `00:${state.timer.toString().padStart(2, '0')}`;
    if (state.timer <= 0) endGame(false);
  }, 1000);
}

function deselectCommands() {
  document.querySelectorAll('.cmd').forEach(c => c.classList.remove('selected'));
}

function applyCommand(type, zone) {
  if (state.puzzleActive) return; // No permitir comandos si el puzzle est√° abierto

  const stepIdx = parseInt(zone.id.split('-')[1]);
  if (stepIdx !== state.currentStep) {
    speak("Comandante, respete el orden de los obst√°culos.");
    return;
  }

  if (type === zone.dataset.need) {
    if (type === 'scan') {
        revealPuzzle();
        deselectCommands();
        return;
    }
    handleSuccess(zone);
    deselectCommands();
  } else {
    audio.beep(150, 0.3);
    speak("Esa habilidad no funciona aqu√≠. ¬°Prueba otra!");
  }
}

function handleSuccess(zone) {
  state.currentStep++;
  zone.classList.add('completed');
  zone.classList.remove('active-step');
  audio.beep(800, 0.2);

  const idx = zone.id.split('-')[1];
  if (idx == 0) {
    document.getElementById('icon-0').innerText = 'üß±‚úÖ';
    speak("¬°Fuerza IA activada! Camino despejado.");
  } else if (idx == 1) {
    document.getElementById('icon-1').innerText = 'üõ°Ô∏è‚úÖ';
    speak("¬°Escudo activado! Bolt cruz√≥ las llamas.");
  } else if (idx == 3) {
    document.getElementById('icon-3').innerText = 'ü•∞';
    speak("¬°Lo logramos! El Fuzzly est√° a salvo gracias a tu coraz√≥n.");
    setTimeout(() => endGame(true), 2500);
  }
  updateUI();
}

function updateUI() {
  document.getElementById('prog-bar').style.width = (state.currentStep / 4 * 100) + '%';
  document.querySelectorAll('.obstacle').forEach((z, i) => {
    z.classList.toggle('active-step', i === state.currentStep);
  });
}

function revealPuzzle() {
  if(state.puzzleActive) return;
  state.puzzleActive = true;
  audio.beep(600, 0.1);
  
  const colors = ['r', 'g', 'b'];
  state.codeSecret = Array.from({length: 3}, () => colors[Math.floor(Math.random() * 3)]);
  
  const target = document.getElementById('code-target');
  target.innerHTML = '';
  state.codeSecret.forEach(c => {
    const dot = document.createElement('div');
    dot.className = 'dot-target';
    dot.style.background = c === 'r' ? '#ff1744' : c === 'g' ? '#00e676' : '#2979ff';
    target.appendChild(dot);
  });
  
  document.getElementById('door-puzzle').style.display = 'flex';
  document.getElementById('icon-2').style.display = 'none';
  state.codeEntered = [];
  document.getElementById('input-dots').innerHTML = '';
  speak("¬°C√≥digo detectado! Pulsa los colores en el mismo orden que ves arriba.");
}

document.querySelectorAll('.color-btn').forEach(btn => {
  btn.addEventListener('click', (e) => {
    e.stopPropagation(); // ¬°ESTO EVITA QUE EL CODIGO CAMBIE!
    if (state.currentStep !== 2) return;
    
    const c = btn.dataset.color;
    state.codeEntered.push(c);
    
    const dot = document.createElement('div');
    dot.style = `width:15px; height:15px; border-radius:50%; background:${btn.style.background}; border:2px solid #fff;`;
    document.getElementById('input-dots').appendChild(dot);
    
    if (state.codeEntered.length === 3) {
      if (state.codeEntered.join('') === state.codeSecret.join('')) {
        state.puzzleActive = false;
        document.getElementById('door-puzzle').style.display = 'none';
        document.getElementById('icon-2').style.display = 'block';
        document.getElementById('icon-2').innerText = 'üö™‚úÖ';
        document.getElementById('chief-speech').classList.remove('visible');
        handleSuccess(document.getElementById('obs-2'));
      } else {
        audio.beep(150, 0.3);
        state.codeEntered = [];
        document.getElementById('input-dots').innerHTML = '';
        speak("¬°Error! Intenta la secuencia otra vez.");
      }
    }
  });
});

document.getElementById('btn-to-briefing').addEventListener('click', () => {
  audio.init();
  showScene('scene-briefing');
  const tutorialText = "¬°Comandante! Bolt (IA) tiene la fuerza para el peligro. T√∫ (Humano) tienes el coraz√≥n para el consuelo. ¬°Trabajen juntos para salvar al Fuzzly!";
  speak(tutorialText);
  document.getElementById('briefing-text').innerText = tutorialText;
});

document.getElementById('btn-start-mission').addEventListener('click', () => {
  showScene('scene-game');
  state.isPaused = false;
  startTimer();
  updateUI();
  speak("¬°Misi√≥n en marcha! Usa la Fuerza IA contra las rocas.");
});

function endGame(win) {
  state.isPaused = true;
  clearInterval(state.timerInterval);
  showScene('scene-final');
  document.getElementById('final-msg').innerText = win 
    ? "Has demostrado que la IA y el Coraz√≥n Humano son el mejor equipo. ¬°Fuzzly est√° feliz!"
    : "El tiempo se acab√≥. ¬°Debemos intentar el rescate otra vez!";
  document.getElementById('final-emoji').innerText = win ? 'üèÜ' : '‚ö†Ô∏è';
}

document.getElementById('btn-restart').addEventListener('click', () => {
  location.reload(); // Forma m√°s limpia de resetear todos los estados
});

document.getElementById('btn-mute').addEventListener('click', function() {
  state.isMuted = !state.isMuted;
  this.innerText = state.isMuted ? 'üîá' : 'üîä';
  if(state.isMuted) speechSynthesis.cancel();
});

document.querySelectorAll('.cmd').forEach(cmd => {
  cmd.addEventListener('dragstart', e => { e.dataTransfer.setData('type', cmd.dataset.type); });
  cmd.addEventListener('click', () => {
    deselectCommands();
    cmd.classList.add('selected');
    audio.beep(500, 0.05);
  });
});

document.querySelectorAll('.obstacle').forEach(zone => {
  zone.addEventListener('dragover', e => e.preventDefault());
  zone.addEventListener('drop', e => {
    e.preventDefault();
    applyCommand(e.dataTransfer.getData('type'), zone);
  });
  zone.addEventListener('click', () => {
    const sel = document.querySelector('.cmd.selected');
    if (sel) applyCommand(sel.dataset.type, zone);
  });
});
</script>
</body>
</html>
